<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNS - Video Chat</title>
    
    <!-- Fontlar -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>

    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1E1E1E;
            --caspian-blue: #007BA7;
            --danger: #FF4D4D;
            --success: #28a745;
            --text-main: #FFFFFF;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            /* Mobil brauzerl…ôrin √ºnvan s…ôtrini n…ôz…ôr…ô almaq √º√ß√ºn 'dvh' */
            height: 100vh;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            height: 60px;
            background-color: var(--bg-panel);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            flex-shrink: 0;
            z-index: 20;
        }

        .brand { display: flex; align-items: center; gap: 8px; }
        
        .logo-symbol { display: flex; align-items: center; }
        .dot { width: 8px; height: 8px; background: var(--caspian-blue); border-radius: 50%; }
        .bridge { width: 15px; height: 2px; background: #FFF; margin: 0 2px; }
        
        .brand h1 { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
        
        .online-count { font-size: 13px; color: #888; font-variant-numeric: tabular-nums; }
        .online-count b { color: var(--caspian-blue); }

        /* --- MAIN VIDEO AREA --- */
        main {
            flex: 1;
            display: flex;
            background: #000;
            position: relative;
            overflow: hidden;
        }

        .video-box {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #remote-box { border-right: 1px solid #333; }
        #local-box { background: #111; }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Lokal videonu g√ºzg√º kimi √ßevir */
        #localVideo { transform: scaleX(-1); }

        /* Overlay Elementl…ôr */
        .label {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(4px);
            z-index: 10;
        }

        .loader {
            position: absolute;
            display: none; /* JS il…ô idar…ô olunur */
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 5;
            color: #ccc;
            font-size: 14px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: var(--caspian-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- FOOTER (CONTROLS) --- */
        footer {
            height: 80px;
            background-color: var(--bg-panel);
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            gap: 10px;
            flex-shrink: 0;
            /* iPhone Home Bar √º√ß√ºn t…ôhl√ºk…ôsiz zona */
            padding-bottom: env(safe-area-inset-bottom); 
            z-index: 20;
        }

        .btn {
            height: 100%;
            max-height: 50px;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 16px;
            color: white;
            cursor: pointer;
            text-transform: uppercase;
            transition: transform 0.1s active;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active { transform: scale(0.96); }

        .btn-start {
            background-color: var(--success);
            flex: 2; /* Geni≈ü yer tutsun */
        }

        .btn-stop {
            background-color: var(--danger);
            flex: 1; /* Daha yƒ±ƒücam olsun */
        }

        .btn:disabled {
            opacity: 0.5;
            background-color: #444;
            cursor: not-allowed;
            transform: none;
        }

        /* --- MOBƒ∞L RESPONSIVE --- */
        @media (max-width: 768px) {
            main { flex-direction: column; }
            
            .video-box { 
                width: 100%; 
                height: 50%; /* Ekranƒ± yarƒ±ya b√∂l */
            }
            
            #remote-box { 
                border-right: none; 
                border-bottom: 1px solid #333; 
            }

            footer {
                padding: 10px;
                gap: 8px;
            }
            
            .btn { font-size: 14px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <div class="logo-symbol">
                <div class="dot"></div>
                <div class="bridge"></div>
                <div class="dot"></div>
            </div>
            <h1>UNS</h1>
        </div>
        <div class="online-count">Online: <b id="onlineCount">...</b></div>
    </header>

    <main>
        <!-- REMOTE (YAD) -->
        <div class="video-box" id="remote-box">
            <div class="label">üåç Yad</div>
            <div class="loader" id="loader">
                <div class="spinner"></div>
                <span>Axtarƒ±lƒ±r...</span>
            </div>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>

        <!-- LOCAL (S∆èN) -->
        <div class="video-box" id="local-box">
            <div class="label">üá¶üáø S…ôn</div>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
    </main>

    <footer>
        <button class="btn btn-start" id="startBtn">BA≈ûLA</button>
        <button class="btn btn-stop" id="stopBtn" disabled>DAYAN</button>
    </footer>

    <script>
        // Render.com v…ô ya Localhost √º√ß√ºn avtomatik socket baƒülantƒ±sƒ±
        const socket = io({ autoConnect: false });

        // --- QARA EKRAN PROBLEMƒ∞Nƒ∞N H∆èLLƒ∞ ---
        // Daha √ßox pulsuz STUN server …ôlav…ô edildi
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ]
        };

        let localStream;
        let peerConnection;
        let isSearching = false;

        // DOM Elementl…ôri
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const loader = document.getElementById('loader');
        const onlineCountEl = document.getElementById('onlineCount');

        // 1. REAL ONLƒ∞NE SAYINI Dƒ∞NLE
        socket.on('users_count', (count) => {
            onlineCountEl.innerText = count;
        });

        // 2. KAMERANI A√á
        async function initCamera() {
            try {
                // Mobild…ô 'facingMode: user' √∂n kameranƒ± m…ôcbur edir
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: true 
                });
                localVideo.srcObject = localStream;
                
                // Kameranƒ± a√ßan kimi socket-…ô qo≈üuluruq ki, onlayn sayƒ±nƒ± g√∂r…ôk
                if (!socket.connected) socket.connect(); 
            } catch (err) {
                console.error(err);
                alert("Kameraya icaz…ô verilm…ôdi! Saytƒ± yenil…ôyin v…ô icaz…ô verin.");
                startBtn.innerText = "KAMERA YOXDUR";
                startBtn.disabled = true;
            }
        }
        
        // S…ôhif…ô y√ºkl…ôn…ônd…ô ba≈ülat
        initCamera();

        // 3. D√úYM∆è M∆èNTƒ∞Qƒ∞
        startBtn.addEventListener('click', () => {
            if (!localStream) return alert("Kamera aktiv deyil!");

            if (!socket.connected) socket.connect();

            // ∆èg…ôr artƒ±q axtarƒ±≈üdadƒ±rsa v…ô ya danƒ±≈üƒ±rsa, k√∂hn…ôni k…ôs v…ô yenisini axtar (NEXT funksiyasƒ±)
            if (isSearching || peerConnection) {
                stopConn(false); // false = serverd…ôn tam √ßƒ±xma, sad…ôc…ô yenil…ô
            }

            isSearching = true;
            updateUI('searching');
            socket.emit('find_partner');
        });

        stopBtn.addEventListener('click', () => {
            // Tamamil…ô dayan (STOP funksiyasƒ±)
            stopConn(true); // true = server…ô 'stop_search' g√∂nd…ôr
        });

        // ∆èlaq…ôni k…ôs…ôn …ôsas funksiya
        function stopConn(fullStop) {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            remoteVideo.srcObject = null;
            isSearching = false;

            if (fullStop) {
                // Server…ô de ki, m…ôni n√∂vb…ôd…ôn sil! (Vacib d√ºz…ôli≈ü)
                socket.emit('stop_search');
                updateUI('stopped');
            }
        }

        // UI D…ôyi≈üiklikl…ôri
        function updateUI(state) {
            if (state === 'searching') {
                startBtn.innerText = "N√ñVB∆èTƒ∞ ‚û°";
                stopBtn.disabled = false;
                loader.style.display = 'flex';
                remoteVideo.style.opacity = '0';
            } 
            else if (state === 'connected') {
                startBtn.innerText = "N√ñVB∆èTƒ∞ ‚û°";
                loader.style.display = 'none';
                remoteVideo.style.opacity = '1';
            } 
            else if (state === 'stopped') {
                startBtn.innerText = "BA≈ûLA";
                stopBtn.disabled = true;
                loader.style.display = 'none';
                remoteVideo.style.opacity = '1'; // Qara ekran qalsƒ±n
            }
        }

        // 4. WEBRTC SIGNALING (Backend il…ô …ôlaq…ô)
        
        socket.on('partner_found', async ({ role }) => {
            updateUI('connected');
            createPeerConnection();

            if (role === 'offerer') {
                try {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    socket.emit('offer', offer);
                } catch (e) { console.error("Offer error:", e); }
            }
        });

        socket.on('offer', async (offer) => {
            if (!peerConnection) createPeerConnection();
            try {
                await peerConnection.setRemoteDescription(offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('answer', answer);
            } catch (e) { console.error("Offer receive error:", e); }
        });

        socket.on('answer', async (answer) => {
            if (peerConnection) {
                try {
                    await peerConnection.setRemoteDescription(answer);
                } catch (e) { console.error("Answer receive error:", e); }
            }
        });

        socket.on('candidate', async (candidate) => {
            if (peerConnection) {
                try {
                    await peerConnection.addIceCandidate(candidate);
                } catch (e) { console.error("Candidate error:", e); }
            }
        });

        socket.on('partner_disconnected', () => {
            // ∆èlaq…ôni t…ômizl…ô
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            remoteVideo.srcObject = null;

            // M∆èNTƒ∞Q: ∆èg…ôr biz h…ôl…ô d…ô axtarƒ±≈ü rejimind…ôyiks…ô (Next basmƒ±≈üƒ±qsa), avtomatik yeni adam tap.
            // ∆èg…ôr "Dayan" basmƒ±≈üƒ±qsa (isSearching = false), he√ß n…ô etm…ô.
            if (isSearching) {
                updateUI('searching');
                socket.emit('find_partner');
            } else {
                updateUI('stopped');
            }
        });

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(rtcConfig);

            // Lokal g√∂r√ºnt√ºn√º qar≈üƒ± t…ôr…ôf…ô g√∂nd…ôr
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Qar≈üƒ± t…ôr…ôfd…ôn g…ôl…ôn g√∂r√ºnt√ºn√º q…ôbul et
            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            // ICE Namiz…ôdl…ôrini server…ô √∂t√ºr
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('candidate', event.candidate);
                }
            };
            
            // WebRTC connection state monitoring (Debug √º√ß√ºn)
            peerConnection.onconnectionstatechange = () => {
                console.log("Connection State:", peerConnection.connectionState);
            };
        }
    </script>
</body>
</html>
